План работ (от простого/рискового к более сложному)

1) Проанализировать задачи
   - Посчитать в `tasks.jsonl` все вхождения MathML и классифицировать: одиночные символы (`<m:mo>–</m:mo>`, `<m:mo>-</m:mo>` и т.п.) vs полноценные формулы.
   - Проверить, в каких полях есть Word-вставки (`<?import namespace = m …>`), скрипты `ShowPictureQ`, лишние атрибуты (`bgcolor`, `width`, `class` и т.д.).

Результаты шага 1 (аудит)
- Всего задач: 2313; MathML есть в 585 задачах (1187 блоков).
- 1175/1187 MathML-блоков — одиночные символы. Чаще всего: `–` — 901. После замены `–` остаются: `∧` — 153, `∈` — 40, битый символ `�` — 72, `—` — 5, `∨` — 4. 6 уникальных сложных формул, самая частая — формула расстояния (7 раз).
- Word-артефакт `<?import namespace = m …>` встречается в 61 задаче (всегда перед MathML символами).
- Скрипты `ShowPictureQ` есть в 605 задачах (вызывают картинки из `assets/*`).

2) Определить правила нормализации MathML
   - Для «простых» фрагментов заменять только `–` на юникод-минус; остальные символы оставлять как есть (чтобы не трогать логику ∧, ∈ и т.п.).
   - Для формул из нескольких тегов: удалять префикс `m:` у тэгов, оставлять `<math>` для MathJax/KaTeX или конвертировать в TeX через `mathml2latex` (решить после аудита по шагу 1).

3) Очистка HTML — ✅ сделано в `transform_tasks.py`
   - Удаляются служебные теги/атрибуты (`style`, `class`, `bgcolor`, `width`, `height`, `align`, `valign`, `lang`, `svwidth`, `border`, `cellpadding`, `cellspacing`, пустые `span/font/o:p`, лишние `div`).
   - Скрипты `ShowPictureQ`/`ShowPictureQ2WH` разворачиваются в `<img>` + ссылка на архив.
   - Нормализуется `br` → `\n`, `&nbsp;` → пробел.

4) Генерация Markdown
   - После очистки конвертировать HTML → GFM через `pypandoc` (приоритет) или `markdownify` с поддержкой таблиц; включить флаг для MathJax.
   - Сохранить результат в новом поле `question_md`, исходный очищенный HTML — в `question_html_clean`.

5) Интеграция в пайплайн
   - Добавить функцию `clean_question_html` и преобразование MathML в `parse_fipi_pages.py` (или отдельный модуль utils).
   - Добавить CLI-режим/скрипт для пересборки `tasks.jsonl` с новыми полями, не затрагивая существующий формат (чтобы можно было откатиться).

6) Валидация и тесты
   - Прогнать `uv run ruff check .` и `uv run mypy parse_fipi_pages.py`.
   - Сделать выборочную проверку рендеринга: несколько задач с таблицами, с MathML-формулами и с картинками.
